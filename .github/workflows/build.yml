name: ğŸ§± Build DLL & release (Windows)

env:
  PLUGIN_NAME: CustomTitle
  PLUGIN_NAME_FORMATTED: Custom Title
  TAG_NAME: ${{ github.event.inputs.tag || github.ref_name }}

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.0.1)"
        required: true
permissions:
  contents: write

jobs:
  check-changelog:
    name: Check changelog (main)
    runs-on: windows-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: ğŸ“¥ Checkout repository (main)
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: false

      - name: ğŸ“ Extract changes from changelog
        id: changelog
        shell: bash
        run: |
          # Prefer manual input if available
          TAG="${{ github.event.inputs.tag || github.ref_name }}"

          # fail if tag not found in CHANGELOG.md
          if ! grep -q "^## $TAG" CHANGELOG.md; then
            echo "âŒ Tag '$TAG' not found in CHANGELOG.md"
            exit 1
          fi

          echo "Using tag: $TAG"

          NOTES=$(awk "/^## $TAG/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md)

          echo "Extracted notes:"
          echo "$NOTES"

          {
            echo "changelog<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build:
    name: Build DLL
    needs: check-changelog
    runs-on: windows-latest # uses pwsh (PowerShell Core) as default shell

    steps:
      - name: ğŸ“¥ Checkout repository (without submodules)
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: ğŸ† Initialize submodules
        run: ./scripts/init-submodules.bat

      - name: ğŸªŸ Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: ğŸ—„ï¸ Cache vcpkg dependencies
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg
            vcpkg_installed
          key: vcpkg-${{ hashFiles('**/vcpkg.json') }}-${{ runner.os }}

      - name: ğŸ“¥ vcpkg setup (if not cached)
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          git clone --recurse-submodules https://github.com/microsoft/vcpkg.git "${{ github.workspace }}/vcpkg"
          ./vcpkg/bootstrap-vcpkg.bat

      - name: ğŸ¥· Set up Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: âš™ï¸ Set up CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: ğŸ§± Configure using CMake preset
        run: cmake --preset windows-x64-msvc

      - name: ğŸ”¨ Build using CMake preset
        run: cmake --build --preset default

      - name: ğŸ¥µ Prepare release files
        shell: bash
        run: |
          mkdir -p dist temp/installation_zip
          cp ./plugins/*.dll temp/installation_zip
          mv ./scripts/install.bat temp/installation_zip
          7z a "dist/${{ env.PLUGIN_NAME }}.zip" ./temp/installation_zip/*

      - name: ğŸ” Generate SHA256 hashes
        id: generate_hashes
        shell: bash
        run: ./scripts/generate-hashes.sh "plugins/*.dll,dist/*.zip"

      - name: ğŸš€ Create release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          WORKFLOW_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          body: |
            ## Install Steps
            1. Close Rocket League

            2. Click `${{ env.PLUGIN_NAME }}.zip` below to download it

            3. Extract `${{ env.PLUGIN_NAME }}.zip` and run `install.bat`
                <details> <summary>Getting an error when running <code>install.bat</code> ?</summary>
                    <ul><br>
                        <li>Drag/drop <code>${{ env.PLUGIN_NAME }}.dll</code> into your bakkesmod plugins folder, usually located here:
                        <br><code>C:\Users\{YOUR USERNAME}\AppData\Roaming\bakkesmod\bakkesmod\plugins</code></li>
                    </ul>
                </details>
                
            ## Notes
            ${{ needs.check-changelog.outputs.changelog }}

            [Build workflow run](${{ env.WORKFLOW_URL }})
          files: dist/*.zip

      - name: ğŸ¤“ Post release info in discord channel
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          nodetail: true
          title: "**${{ env.PLUGIN_NAME_FORMATTED }}** `${{ env.TAG_NAME }}` has been released! ğŸ·ï¸ ğŸš€"
          description: |
            ### Notes
            ${{ needs.check-changelog.outputs.changelog }}

            **Download:** [${{ env.TAG_NAME }}](${{ steps.create_release.outputs.url }})
          color: 0xFF0730
